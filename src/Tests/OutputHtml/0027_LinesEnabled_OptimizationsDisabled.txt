
<pre class="background">
<table>
<tbody>
<tr><td class="line_no" line_no="1"></td><td class="code_column"><span class="keyword">using</span> <span class="namespace">System</span><span class="punctuation">;</span></td></tr><tr><td class="line_no" line_no="2"></td><td class="code_column"><span class="keyword">using</span> <span class="namespace">System</span><span class="operator">.</span><span class="namespace">Collections</span><span class="operator">.</span><span class="namespace">Concurrent</span><span class="punctuation">;</span></td></tr><tr><td class="line_no" line_no="3"></td><td class="code_column"><span class="keyword">using</span> <span class="namespace">System</span><span class="operator">.</span><span class="namespace">Collections</span><span class="operator">.</span><span class="namespace">Generic</span><span class="punctuation">;</span></td></tr><tr><td class="line_no" line_no="4"></td><td class="code_column"><span class="keyword">using</span> <span class="namespace">System</span><span class="operator">.</span><span class="namespace">Runtime</span><span class="operator">.</span><span class="namespace">InteropServices</span><span class="punctuation">;</span></td></tr><tr><td class="line_no" line_no="5"></td><td class="code_column"><span class="keyword">using</span> <span class="namespace">System</span><span class="operator">.</span><span class="namespace">Threading</span><span class="punctuation">;</span></td></tr><tr><td class="line_no" line_no="6"></td><td></tr><tr><td class="line_no" line_no="7"></td><td class="code_column"><span class="keyword">namespace</span> <span class="namespace">AsyncWithFibers</span></td></tr><tr><td class="line_no" line_no="8"></td><td class="code_column"><span class="punctuation">{</span></td></tr><tr><td class="line_no" line_no="9"></td><td class="code_column">    <span class="keyword">class</span> <span class="class">Program</span></td></tr><tr><td class="line_no" line_no="10"></td><td class="code_column">    <span class="punctuation">{</span></td></tr><tr><td class="line_no" line_no="11"></td><td class="code_column">        <span class="keyword">static</span> <span class="keyword">void</span> <span class="method">Main</span><span class="punctuation">(</span><span class="keyword">string</span><span class="punctuation">[</span><span class="punctuation">]</span> <span class="parameter">args</span><span class="punctuation">)</span></td></tr><tr><td class="line_no" line_no="12"></td><td class="code_column">        <span class="punctuation">{</span></td></tr><tr><td class="line_no" line_no="13"></td><td class="code_column">            <span class="class">HKTMonadFiberAsync</span><span class="operator">.</span><span class="method">Run</span><span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">;</span></td></tr><tr><td class="line_no" line_no="14"></td><td class="code_column">        <span class="punctuation">}</span></td></tr><tr><td class="line_no" line_no="15"></td><td></tr><tr><td class="line_no" line_no="16"></td><td class="code_column">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="method">WhereAmI</span><span class="punctuation">(</span><span class="keyword">string</span> <span class="parameter">what</span><span class="punctuation">)</span></td></tr><tr><td class="line_no" line_no="17"></td><td class="code_column">        <span class="punctuation">{</span></td></tr><tr><td class="line_no" line_no="18"></td><td class="code_column">            <span class="class">Console</span><span class="operator">.</span><span class="method">WriteLine</span><span class="punctuation">(</span><span class="string">$&quot;</span><span class="string">Thread</span> <span class="punctuation">{</span><span class="class">Thread</span><span class="operator">.</span><span class="propertyName">CurrentThread</span><span class="operator">.</span><span class="propertyName">ManagedThreadId</span><span class="punctuation">}</span> <span class="string">Time</span> <span class="punctuation">{</span><span class="struct">DateTime</span><span class="operator">.</span><span class="propertyName">Now</span><span class="punctuation">}</span><span class="string">:</span> <span class="punctuation">{</span><span class="parameter">what</span><span class="punctuation">}</span><span class="string">&quot;</span><span class="punctuation">)</span><span class="punctuation">;</span></td></tr><tr><td class="line_no" line_no="19"></td><td class="code_column">        <span class="punctuation">}</span></td></tr><tr><td class="line_no" line_no="20"></td><td class="code_column">    <span class="punctuation">}</span></td></tr><tr><td class="line_no" line_no="21"></td><td></tr><tr><td class="line_no" line_no="22"></td><td class="code_column">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="class">FiberHelper</span></td></tr><tr><td class="line_no" line_no="23"></td><td class="code_column">    <span class="punctuation">{</span></td></tr><tr><td class="line_no" line_no="24"></td><td class="code_column">        <span class="punctuation">[</span><span class="class">DllImport</span><span class="punctuation">(</span><span class="string">&quot;kernel32.dll&quot;</span><span class="punctuation">)</span><span class="punctuation">]</span></td></tr><tr><td class="line_no" line_no="25"></td><td class="code_column">        <span class="keyword">static</span> <span class="keyword">extern</span> <span class="struct">IntPtr</span> <span class="method">ConvertThreadToFiber</span><span class="punctuation">(</span><span class="struct">IntPtr</span> <span class="parameter">lpParameter</span><span class="punctuation">)</span><span class="punctuation">;</span></td></tr><tr><td class="line_no" line_no="26"></td><td></tr><tr><td class="line_no" line_no="27"></td><td class="code_column">        <span class="punctuation">[</span><span class="class">DllImport</span><span class="punctuation">(</span><span class="string">&quot;kernel32.dll&quot;</span><span class="punctuation">)</span><span class="punctuation">]</span></td></tr><tr><td class="line_no" line_no="28"></td><td class="code_column">        <span class="keyword">static</span> <span class="keyword">extern</span> <span class="struct">IntPtr</span> <span class="method">CreateFiber</span><span class="punctuation">(</span><span class="keyword">uint</span> <span class="parameter">dwStackSize</span><span class="punctuation">,</span> <span class="struct">IntPtr</span> <span class="parameter">lpStartAddress</span><span class="punctuation">,</span> <span class="struct">IntPtr</span> <span class="parameter">lpParameter</span><span class="punctuation">)</span><span class="punctuation">;</span></td></tr><tr><td class="line_no" line_no="29"></td><td></tr><tr><td class="line_no" line_no="30"></td><td class="code_column">        <span class="punctuation">[</span><span class="class">DllImport</span><span class="punctuation">(</span><span class="string">&quot;kernel32.dll&quot;</span><span class="punctuation">)</span><span class="punctuation">]</span></td></tr><tr><td class="line_no" line_no="31"></td><td class="code_column">        <span class="keyword">static</span> <span class="keyword">extern</span> <span class="struct">IntPtr</span> <span class="method">SwitchToFiber</span><span class="punctuation">(</span><span class="struct">IntPtr</span> <span class="parameter">lpStartAddress</span><span class="punctuation">)</span><span class="punctuation">;</span></td></tr><tr><td class="line_no" line_no="32"></td><td></tr><tr><td class="line_no" line_no="33"></td><td class="code_column">        <span class="punctuation">[</span><span class="class">DllImport</span><span class="punctuation">(</span><span class="string">&quot;kernel32.dll&quot;</span><span class="punctuation">)</span><span class="punctuation">]</span></td></tr><tr><td class="line_no" line_no="34"></td><td class="code_column">        <span class="keyword">static</span> <span class="keyword">extern</span> <span class="struct">IntPtr</span> <span class="method">DeleteFiber</span><span class="punctuation">(</span><span class="struct">IntPtr</span> <span class="parameter">lpStartAddress</span><span class="punctuation">)</span><span class="punctuation">;</span></td></tr><tr><td class="line_no" line_no="35"></td><td></tr><tr><td class="line_no" line_no="36"></td><td class="code_column">        <span class="class">Dictionary</span><span class="punctuation">&lt;</span><span class="keyword">int</span><span class="punctuation">,</span> <span class="struct">IntPtr</span><span class="punctuation">&gt;</span> <span class="fieldName">actions</span><span class="punctuation">;</span></td></tr><tr><td class="line_no" line_no="37"></td><td class="code_column">        <span class="keyword">public</span> <span class="struct">IntPtr</span> <span class="fieldName">fiberCaller</span><span class="punctuation">;</span></td></tr><tr><td class="line_no" line_no="38"></td><td></tr><tr><td class="line_no" line_no="39"></td><td class="code_column">        <span class="keyword">public</span> <span class="class">FiberHelper</span><span class="punctuation">(</span><span class="punctuation">)</span></td></tr><tr><td class="line_no" line_no="40"></td><td class="code_column">        <span class="punctuation">{</span></td></tr><tr><td class="line_no" line_no="41"></td><td class="code_column">            <span class="fieldName">actions</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="class">Dictionary</span><span class="punctuation">&lt;</span><span class="keyword">int</span><span class="punctuation">,</span> <span class="struct">IntPtr</span><span class="punctuation">&gt;</span><span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">;</span></td></tr><tr><td class="line_no" line_no="42"></td><td class="code_column">        <span class="punctuation">}</span></td></tr><tr><td class="line_no" line_no="43"></td><td></tr><tr><td class="line_no" line_no="44"></td><td class="code_column">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="method">Convert</span><span class="punctuation">(</span><span class="punctuation">)</span></td></tr><tr><td class="line_no" line_no="45"></td><td class="code_column">        <span class="punctuation">{</span></td></tr><tr><td class="line_no" line_no="46"></td><td class="code_column">            <span class="fieldName">actions</span><span class="operator">.</span><span class="method">Add</span><span class="punctuation">(</span><span class="numericLiteral">0</span><span class="punctuation">,</span> <span class="method">ConvertThreadToFiber</span><span class="punctuation">(</span><span class="struct">IntPtr</span><span class="operator">.</span><span class="fieldName">Zero</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">;</span></td></tr><tr><td class="line_no" line_no="47"></td><td class="code_column">        <span class="punctuation">}</span></td></tr><tr><td class="line_no" line_no="48"></td><td></tr><tr><td class="line_no" line_no="49"></td><td class="code_column">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="method">Create</span><span class="punctuation">(</span><span class="keyword">int</span> <span class="parameter">action</span><span class="punctuation">)</span></td></tr><tr><td class="line_no" line_no="50"></td><td class="code_column">        <span class="punctuation">{</span></td></tr><tr><td class="line_no" line_no="51"></td><td class="code_column">            <span class="fieldName">actions</span><span class="operator">.</span><span class="method">Add</span><span class="punctuation">(</span><span class="parameter">action</span><span class="punctuation">,</span> <span class="method">CreateFiber</span><span class="punctuation">(</span><span class="numericLiteral">1024</span> <span class="operator">*</span> <span class="numericLiteral">1024</span><span class="punctuation">,</span> <span class="fieldName">fiberCaller</span><span class="punctuation">,</span> <span class="punctuation">(</span><span class="struct">IntPtr</span><span class="punctuation">)</span><span class="parameter">action</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">;</span></td></tr><tr><td class="line_no" line_no="52"></td><td class="code_column">        <span class="punctuation">}</span></td></tr><tr><td class="line_no" line_no="53"></td><td></tr><tr><td class="line_no" line_no="54"></td><td class="code_column">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="method">Switch</span><span class="punctuation">(</span><span class="keyword">int</span> <span class="parameter">action</span><span class="punctuation">)</span></td></tr><tr><td class="line_no" line_no="55"></td><td class="code_column">        <span class="punctuation">{</span></td></tr><tr><td class="line_no" line_no="56"></td><td class="code_column">            <span class="class">Thread</span><span class="operator">.</span><span class="method">Sleep</span><span class="punctuation">(</span><span class="numericLiteral">100</span><span class="punctuation">)</span><span class="punctuation">;</span></td></tr><tr><td class="line_no" line_no="57"></td><td class="code_column">            <span class="struct">IntPtr</span> <span class="localName">param</span> <span class="operator">=</span> <span class="fieldName">actions</span><span class="punctuation">[</span><span class="parameter">action</span><span class="punctuation">]</span><span class="punctuation">;</span></td></tr><tr><td class="line_no" line_no="58"></td><td class="code_column">            <span class="method">SwitchToFiber</span><span class="punctuation">(</span><span class="localName">param</span><span class="punctuation">)</span><span class="punctuation">;</span></td></tr><tr><td class="line_no" line_no="59"></td><td class="code_column">        <span class="punctuation">}</span></td></tr><tr><td class="line_no" line_no="60"></td><td></tr><tr><td class="line_no" line_no="61"></td><td class="code_column">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="method">Delete</span><span class="punctuation">(</span><span class="keyword">int</span> <span class="parameter">action</span><span class="punctuation">)</span></td></tr><tr><td class="line_no" line_no="62"></td><td class="code_column">        <span class="punctuation">{</span></td></tr><tr><td class="line_no" line_no="63"></td><td class="code_column">            <span class="method">DeleteFiber</span><span class="punctuation">(</span><span class="fieldName">actions</span><span class="punctuation">[</span><span class="parameter">action</span><span class="punctuation">]</span><span class="punctuation">)</span><span class="punctuation">;</span></td></tr><tr><td class="line_no" line_no="64"></td><td class="code_column">        <span class="punctuation">}</span></td></tr><tr><td class="line_no" line_no="65"></td><td class="code_column">    <span class="punctuation">}</span></td></tr><tr><td class="line_no" line_no="66"></td><td></tr><tr><td class="line_no" line_no="67"></td><td class="code_column">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="class">HKTMonadFiberAsync</span></td></tr><tr><td class="line_no" line_no="68"></td><td class="code_column">    <span class="punctuation">{</span></td></tr><tr><td class="line_no" line_no="69"></td><td class="code_column">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="class">ConcurrentDictionary</span><span class="punctuation">&lt;</span><span class="keyword">int</span><span class="punctuation">,</span> <span class="keyword">byte</span><span class="punctuation">&gt;</span> <span class="fieldName">readyToGo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="class">ConcurrentDictionary</span><span class="punctuation">&lt;</span><span class="keyword">int</span><span class="punctuation">,</span> <span class="keyword">byte</span><span class="punctuation">&gt;</span><span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">;</span></td></tr><tr><td class="line_no" line_no="70"></td><td class="code_column">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="class">ConcurrentDictionary</span><span class="punctuation">&lt;</span><span class="keyword">int</span><span class="punctuation">,</span> <span class="delegate">Action</span><span class="punctuation">&gt;</span> <span class="fieldName">allJobs</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="class">ConcurrentDictionary</span><span class="punctuation">&lt;</span><span class="keyword">int</span><span class="punctuation">,</span> <span class="delegate">Action</span><span class="punctuation">&gt;</span><span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">;</span></td></tr><tr><td class="line_no" line_no="71"></td><td class="code_column">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="class">FiberHelper</span> <span class="fieldName">helper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="class">FiberHelper</span><span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">;</span></td></tr><tr><td class="line_no" line_no="72"></td><td class="code_column">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="fieldName">current</span><span class="punctuation">;</span></td></tr><tr><td class="line_no" line_no="73"></td><td class="code_column">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">bool</span> <span class="fieldName">done</span><span class="punctuation">;</span></td></tr><tr><td class="line_no" line_no="74"></td><td></tr><tr><td class="line_no" line_no="75"></td><td class="code_column">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="method">StartFiber</span><span class="punctuation">(</span><span class="keyword">int</span> <span class="parameter">actionId</span><span class="punctuation">)</span></td></tr><tr><td class="line_no" line_no="76"></td><td class="code_column">        <span class="punctuation">{</span></td></tr><tr><td class="line_no" line_no="77"></td><td class="code_column">            <span class="fieldName">allJobs</span><span class="punctuation">[</span><span class="parameter">actionId</span><span class="punctuation">]</span><span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">;</span></td></tr><tr><td class="line_no" line_no="78"></td><td class="code_column">            <span class="control">if</span> <span class="punctuation">(</span><span class="parameter">actionId</span> <span class="operator">!=</span> <span class="numericLiteral">0</span><span class="punctuation">)</span></td></tr><tr><td class="line_no" line_no="79"></td><td class="code_column">            <span class="punctuation">{</span></td></tr><tr><td class="line_no" line_no="80"></td><td class="code_column">                <span class="class">HKTMonadFiberAsync</span><span class="operator">.</span><span class="fieldName">done</span> <span class="operator">=</span> <span class="keyword">true</span><span class="punctuation">;</span></td></tr><tr><td class="line_no" line_no="81"></td><td class="code_column">                <span class="class">HKTMonadFiberAsync</span><span class="operator">.</span><span class="fieldName">helper</span><span class="operator">.</span><span class="method">Switch</span><span class="punctuation">(</span><span class="numericLiteral">0</span><span class="punctuation">)</span><span class="punctuation">;</span></td></tr><tr><td class="line_no" line_no="82"></td><td class="code_column">            <span class="punctuation">}</span></td></tr><tr><td class="line_no" line_no="83"></td><td></tr><tr><td class="line_no" line_no="84"></td><td class="code_column">            <span class="control">return</span> <span class="numericLiteral">0</span><span class="punctuation">;</span></td></tr><tr><td class="line_no" line_no="85"></td><td class="code_column">        <span class="punctuation">}</span></td></tr><tr><td class="line_no" line_no="86"></td><td></tr><tr><td class="line_no" line_no="87"></td><td class="code_column">        <span class="keyword">delegate</span> <span class="keyword">int</span> <span class="delegate">StartFiberDelegate</span><span class="punctuation">(</span><span class="keyword">int</span> <span class="parameter">actionId</span><span class="punctuation">)</span><span class="punctuation">;</span></td></tr><tr><td class="line_no" line_no="88"></td><td></tr><tr><td class="line_no" line_no="89"></td><td class="code_column">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="method">Run</span><span class="punctuation">(</span><span class="punctuation">)</span></td></tr><tr><td class="line_no" line_no="90"></td><td class="code_column">        <span class="punctuation">{</span></td></tr><tr><td class="line_no" line_no="91"></td><td class="code_column">            <span class="fieldName">helper</span><span class="operator">.</span><span class="fieldName">fiberCaller</span> <span class="operator">=</span> <span class="class">Marshal</span><span class="operator">.</span><span class="method">GetFunctionPointerForDelegate</span><span class="punctuation">(</span><span class="punctuation">(</span><span class="delegate">StartFiberDelegate</span><span class="punctuation">)</span><span class="method">StartFiber</span><span class="punctuation">)</span><span class="punctuation">;</span></td></tr><tr><td class="line_no" line_no="92"></td><td></tr><tr><td class="line_no" line_no="93"></td><td class="code_column">            <span class="fieldName">helper</span><span class="operator">.</span><span class="method">Convert</span><span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">;</span></td></tr><tr><td class="line_no" line_no="94"></td><td></tr><tr><td class="line_no" line_no="95"></td><td class="code_column">            <span class="fieldName">allJobs</span><span class="operator">.</span><span class="method">TryAdd</span><span class="punctuation">(</span><span class="numericLiteral">1</span><span class="punctuation">,</span> <span class="method">RunInternal</span><span class="punctuation">)</span><span class="punctuation">;</span></td></tr><tr><td class="line_no" line_no="96"></td><td class="code_column">            <span class="fieldName">readyToGo</span><span class="operator">.</span><span class="method">TryAdd</span><span class="punctuation">(</span><span class="numericLiteral">1</span><span class="punctuation">,</span> <span class="numericLiteral">0</span><span class="punctuation">)</span><span class="punctuation">;</span></td></tr><tr><td class="line_no" line_no="97"></td><td class="code_column">            <span class="fieldName">helper</span><span class="operator">.</span><span class="method">Create</span><span class="punctuation">(</span><span class="numericLiteral">1</span><span class="punctuation">)</span><span class="punctuation">;</span></td></tr><tr><td class="line_no" line_no="98"></td><td></tr><tr><td class="line_no" line_no="99"></td><td class="code_column">            <span class="fieldName">allJobs</span><span class="operator">.</span><span class="method">TryAdd</span><span class="punctuation">(</span><span class="numericLiteral">2</span><span class="punctuation">,</span> <span class="method">SideJob</span><span class="punctuation">)</span><span class="punctuation">;</span></td></tr><tr><td class="line_no" line_no="100"></td><td class="code_column">            <span class="fieldName">readyToGo</span><span class="operator">.</span><span class="method">TryAdd</span><span class="punctuation">(</span><span class="numericLiteral">2</span><span class="punctuation">,</span> <span class="numericLiteral">0</span><span class="punctuation">)</span><span class="punctuation">;</span></td></tr><tr><td class="line_no" line_no="101"></td><td class="code_column">            <span class="fieldName">helper</span><span class="operator">.</span><span class="method">Create</span><span class="punctuation">(</span><span class="numericLiteral">2</span><span class="punctuation">)</span><span class="punctuation">;</span></td></tr><tr><td class="line_no" line_no="102"></td><td></tr><tr><td class="line_no" line_no="103"></td><td></tr><tr><td class="line_no" line_no="104"></td><td class="code_column">            <span class="control">while</span> <span class="punctuation">(</span><span class="keyword">true</span><span class="punctuation">)</span></td></tr><tr><td class="line_no" line_no="105"></td><td class="code_column">            <span class="punctuation">{</span></td></tr><tr><td class="line_no" line_no="106"></td><td class="code_column">                <span class="fieldName">done</span> <span class="operator">=</span> <span class="keyword">false</span><span class="punctuation">;</span></td></tr><tr><td class="line_no" line_no="107"></td><td class="code_column">                <span class="keyword">var</span> <span class="localName">keys</span> <span class="operator">=</span> <span class="fieldName">readyToGo</span><span class="operator">.</span><span class="propertyName">Keys</span><span class="operator">.</span><span class="method">GetEnumerator</span><span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">;</span></td></tr><tr><td class="line_no" line_no="108"></td><td class="code_column">                <span class="control">while</span> <span class="punctuation">(</span><span class="localName">keys</span><span class="operator">.</span><span class="method">MoveNext</span><span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">)</span></td></tr><tr><td class="line_no" line_no="109"></td><td class="code_column">                <span class="punctuation">{</span></td></tr><tr><td class="line_no" line_no="110"></td><td class="code_column">                    <span class="fieldName">current</span> <span class="operator">=</span> <span class="localName">keys</span><span class="operator">.</span><span class="propertyName">Current</span><span class="punctuation">;</span></td></tr><tr><td class="line_no" line_no="111"></td><td class="code_column">                    <span class="fieldName">helper</span><span class="operator">.</span><span class="method">Switch</span><span class="punctuation">(</span><span class="fieldName">current</span><span class="punctuation">)</span><span class="punctuation">;</span></td></tr><tr><td class="line_no" line_no="112"></td><td class="code_column">                    <span class="control">if</span> <span class="punctuation">(</span><span class="fieldName">done</span><span class="punctuation">)</span></td></tr><tr><td class="line_no" line_no="113"></td><td class="code_column">                    <span class="punctuation">{</span></td></tr><tr><td class="line_no" line_no="114"></td><td class="code_column">                        <span class="fieldName">helper</span><span class="operator">.</span><span class="method">Delete</span><span class="punctuation">(</span><span class="fieldName">current</span><span class="punctuation">)</span><span class="punctuation">;</span></td></tr><tr><td class="line_no" line_no="115"></td><td class="code_column">                        <span class="delegate">Action</span> <span class="localName">action</span><span class="punctuation">;</span></td></tr><tr><td class="line_no" line_no="116"></td><td class="code_column">                        <span class="fieldName">allJobs</span><span class="operator">.</span><span class="method">TryRemove</span><span class="punctuation">(</span><span class="fieldName">current</span><span class="punctuation">,</span> <span class="keyword">out</span> <span class="localName">action</span><span class="punctuation">)</span><span class="punctuation">;</span></td></tr><tr><td class="line_no" line_no="117"></td><td class="code_column">                        <span class="keyword">byte</span> <span class="localName">b</span><span class="punctuation">;</span></td></tr><tr><td class="line_no" line_no="118"></td><td class="code_column">                        <span class="fieldName">readyToGo</span><span class="operator">.</span><span class="method">TryRemove</span><span class="punctuation">(</span><span class="fieldName">current</span><span class="punctuation">,</span> <span class="keyword">out</span> <span class="localName">b</span><span class="punctuation">)</span><span class="punctuation">;</span></td></tr><tr><td class="line_no" line_no="119"></td><td class="code_column">                    <span class="punctuation">}</span></td></tr><tr><td class="line_no" line_no="120"></td><td class="code_column">                <span class="punctuation">}</span></td></tr><tr><td class="line_no" line_no="121"></td><td></tr><tr><td class="line_no" line_no="122"></td><td class="code_column">                <span class="control">if</span> <span class="punctuation">(</span><span class="fieldName">allJobs</span><span class="operator">.</span><span class="propertyName">IsEmpty</span><span class="punctuation">)</span></td></tr><tr><td class="line_no" line_no="123"></td><td class="code_column">                <span class="punctuation">{</span></td></tr><tr><td class="line_no" line_no="124"></td><td class="code_column">                    <span class="control">break</span><span class="punctuation">;</span></td></tr><tr><td class="line_no" line_no="125"></td><td class="code_column">                <span class="punctuation">}</span></td></tr><tr><td class="line_no" line_no="126"></td><td></tr><tr><td class="line_no" line_no="127"></td><td class="code_column">                <span class="class">Thread</span><span class="operator">.</span><span class="method">Sleep</span><span class="punctuation">(</span><span class="numericLiteral">1</span><span class="punctuation">)</span><span class="punctuation">;</span></td></tr><tr><td class="line_no" line_no="128"></td><td class="code_column">            <span class="punctuation">}</span></td></tr><tr><td class="line_no" line_no="129"></td><td class="code_column">        <span class="punctuation">}</span></td></tr><tr><td class="line_no" line_no="130"></td><td></tr><tr><td class="line_no" line_no="131"></td><td class="code_column">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="method">RunInternal</span><span class="punctuation">(</span><span class="punctuation">)</span></td></tr><tr><td class="line_no" line_no="132"></td><td class="code_column">        <span class="punctuation">{</span></td></tr><tr><td class="line_no" line_no="133"></td><td class="code_column">            <span class="class">Program</span><span class="operator">.</span><span class="method">WhereAmI</span><span class="punctuation">(</span><span class="string">&quot;\tBefore nesting&quot;</span><span class="punctuation">)</span><span class="punctuation">;</span></td></tr><tr><td class="line_no" line_no="134"></td><td></tr><tr><td class="line_no" line_no="135"></td><td class="code_column">            <span class="method">RunInternalNested</span><span class="punctuation">&lt;</span><span class="class">AsyncBuilder</span><span class="punctuation">&gt;</span><span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">;</span></td></tr><tr><td class="line_no" line_no="136"></td><td class="code_column">            <span class="comment">//RunInternalNested&lt;IdBuilder&gt;();</span></td></tr><tr><td class="line_no" line_no="137"></td><td></tr><tr><td class="line_no" line_no="138"></td><td class="code_column">            <span class="class">Program</span><span class="operator">.</span><span class="method">WhereAmI</span><span class="punctuation">(</span><span class="string">&quot;\tAfter nesting&quot;</span><span class="punctuation">)</span><span class="punctuation">;</span></td></tr><tr><td class="line_no" line_no="139"></td><td class="code_column">        <span class="punctuation">}</span></td></tr><tr><td class="line_no" line_no="140"></td><td></tr><tr><td class="line_no" line_no="141"></td><td class="code_column">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="method">RunInternalNested</span><span class="punctuation">&lt;</span><span class="typeParam">T</span><span class="punctuation">&gt;</span><span class="punctuation">(</span><span class="punctuation">)</span> <span class="keyword">where</span> <span class="typeParam">T</span> <span class="punctuation">:</span> <span class="class">Builder</span><span class="punctuation">,</span> <span class="keyword">new</span><span class="punctuation">(</span><span class="punctuation">)</span></td></tr><tr><td class="line_no" line_no="142"></td><td class="code_column">        <span class="punctuation">{</span></td></tr><tr><td class="line_no" line_no="143"></td><td class="code_column">            <span class="class">Program</span><span class="operator">.</span><span class="method">WhereAmI</span><span class="punctuation">(</span><span class="string">&quot;\t\tBefore creating delay&quot;</span><span class="punctuation">)</span><span class="punctuation">;</span></td></tr><tr><td class="line_no" line_no="144"></td><td></tr><tr><td class="line_no" line_no="145"></td><td class="code_column">            <span class="method">Delay</span><span class="punctuation">&lt;</span><span class="typeParam">T</span><span class="punctuation">&gt;</span><span class="punctuation">(</span><span class="numericLiteral">2000</span><span class="punctuation">)</span><span class="punctuation">;</span></td></tr><tr><td class="line_no" line_no="146"></td><td></tr><tr><td class="line_no" line_no="147"></td><td class="code_column">            <span class="class">Program</span><span class="operator">.</span><span class="method">WhereAmI</span><span class="punctuation">(</span><span class="string">&quot;\t\tAfter sleeping&quot;</span><span class="punctuation">)</span><span class="punctuation">;</span></td></tr><tr><td class="line_no" line_no="148"></td><td></tr><tr><td class="line_no" line_no="149"></td><td class="code_column">            <span class="keyword">var</span> <span class="localName">data</span> <span class="operator">=</span> <span class="method">Data</span><span class="punctuation">&lt;</span><span class="typeParam">T</span><span class="punctuation">,</span> <span class="keyword">string</span><span class="punctuation">&gt;</span><span class="punctuation">(</span><span class="string">&quot;Some string&quot;</span><span class="punctuation">)</span><span class="punctuation">;</span></td></tr><tr><td class="line_no" line_no="150"></td><td></tr><tr><td class="line_no" line_no="151"></td><td class="code_column">            <span class="class">Program</span><span class="operator">.</span><span class="method">WhereAmI</span><span class="punctuation">(</span><span class="string">$&quot;</span><span class="string">\t\tAfter creating data</span> <span class="punctuation">{</span><span class="localName">data</span><span class="punctuation">}</span><span class="string">&quot;</span><span class="punctuation">)</span><span class="punctuation">;</span></td></tr><tr><td class="line_no" line_no="152"></td><td class="code_column">        <span class="punctuation">}</span></td></tr><tr><td class="line_no" line_no="153"></td><td></tr><tr><td class="line_no" line_no="154"></td><td class="code_column">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="method">Delay</span><span class="punctuation">&lt;</span><span class="typeParam">T</span><span class="punctuation">&gt;</span><span class="punctuation">(</span><span class="keyword">int</span> <span class="parameter">timeout</span><span class="punctuation">)</span> <span class="keyword">where</span> <span class="typeParam">T</span> <span class="punctuation">:</span> <span class="class">Builder</span><span class="punctuation">,</span> <span class="keyword">new</span><span class="punctuation">(</span><span class="punctuation">)</span></td></tr><tr><td class="line_no" line_no="155"></td><td class="code_column">        <span class="punctuation">{</span></td></tr><tr><td class="line_no" line_no="156"></td><td class="code_column">            <span class="keyword">var</span> <span class="localName">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="typeParam">T</span><span class="punctuation">(</span><span class="punctuation">)</span><span class="operator">.</span><span class="method">Build</span><span class="punctuation">&lt;</span><span class="keyword">object</span><span class="punctuation">&gt;</span><span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">;</span></td></tr><tr><td class="line_no" line_no="157"></td><td class="code_column">            <span class="keyword">var</span> <span class="localName">timer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="class">Timer</span><span class="punctuation">(</span><span class="parameter">_</span> <span class="operator">=&gt;</span> <span class="localName">context</span><span class="operator">.</span><span class="method">Complete</span><span class="punctuation">(</span><span class="keyword">new</span> <span class="keyword">object</span><span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">)</span><span class="punctuation">,</span> <span class="keyword">null</span><span class="punctuation">,</span> <span class="parameter">timeout</span><span class="punctuation">,</span> <span class="class">Timeout</span><span class="operator">.</span><span class="constant">Infinite</span><span class="punctuation">)</span><span class="punctuation">;</span></td></tr><tr><td class="line_no" line_no="158"></td><td class="code_column">            <span class="class">GC</span><span class="operator">.</span><span class="method">KeepAlive</span><span class="punctuation">(</span><span class="localName">timer</span><span class="punctuation">)</span><span class="punctuation">;</span></td></tr><tr><td class="line_no" line_no="159"></td><td class="code_column">            <span class="localName">context</span><span class="operator">.</span><span class="method">Map</span><span class="punctuation">(</span><span class="punctuation">(</span><span class="keyword">object</span><span class="punctuation">)</span><span class="keyword">null</span><span class="punctuation">,</span> <span class="parameter">_</span> <span class="operator">=&gt;</span> <span class="parameter">timeout</span><span class="punctuation">)</span><span class="punctuation">;</span></td></tr><tr><td class="line_no" line_no="160"></td><td class="code_column">        <span class="punctuation">}</span></td></tr><tr><td class="line_no" line_no="161"></td><td></tr><tr><td class="line_no" line_no="162"></td><td class="code_column">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="typeParam">U</span> <span class="method">Data</span><span class="punctuation">&lt;</span><span class="typeParam">T</span><span class="punctuation">,</span> <span class="typeParam">U</span><span class="punctuation">&gt;</span><span class="punctuation">(</span><span class="typeParam">U</span> <span class="parameter">d</span><span class="punctuation">)</span> <span class="keyword">where</span> <span class="typeParam">T</span> <span class="punctuation">:</span> <span class="class">Builder</span><span class="punctuation">,</span> <span class="keyword">new</span><span class="punctuation">(</span><span class="punctuation">)</span></td></tr><tr><td class="line_no" line_no="163"></td><td class="code_column">        <span class="punctuation">{</span></td></tr><tr><td class="line_no" line_no="164"></td><td class="code_column">            <span class="keyword">var</span> <span class="localName">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="typeParam">T</span><span class="punctuation">(</span><span class="punctuation">)</span><span class="operator">.</span><span class="method">Build</span><span class="punctuation">&lt;</span><span class="typeParam">U</span><span class="punctuation">&gt;</span><span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">;</span></td></tr><tr><td class="line_no" line_no="165"></td><td class="code_column">            <span class="control">return</span> <span class="localName">context</span><span class="operator">.</span><span class="method">Map</span><span class="punctuation">(</span><span class="parameter">d</span><span class="punctuation">,</span> <span class="parameter">_</span> <span class="operator">=&gt;</span> <span class="parameter">d</span><span class="punctuation">)</span><span class="punctuation">;</span></td></tr><tr><td class="line_no" line_no="166"></td><td class="code_column">        <span class="punctuation">}</span></td></tr><tr><td class="line_no" line_no="167"></td><td></tr><tr><td class="line_no" line_no="168"></td><td class="code_column">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="method">SideJob</span><span class="punctuation">(</span><span class="punctuation">)</span></td></tr><tr><td class="line_no" line_no="169"></td><td class="code_column">        <span class="punctuation">{</span></td></tr><tr><td class="line_no" line_no="170"></td><td class="code_column">            <span class="class">Program</span><span class="operator">.</span><span class="method">WhereAmI</span><span class="punctuation">(</span><span class="string">&quot;\tSide job&quot;</span><span class="punctuation">)</span><span class="punctuation">;</span></td></tr><tr><td class="line_no" line_no="171"></td><td class="code_column">        <span class="punctuation">}</span></td></tr><tr><td class="line_no" line_no="172"></td><td class="code_column">    <span class="punctuation">}</span></td></tr><tr><td class="line_no" line_no="173"></td><td></tr><tr><td class="line_no" line_no="174"></td><td class="code_column">    <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="class">Builder</span></td></tr><tr><td class="line_no" line_no="175"></td><td class="code_column">    <span class="punctuation">{</span></td></tr><tr><td class="line_no" line_no="176"></td><td class="code_column">        <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="interface">Monad</span><span class="punctuation">&lt;</span><span class="typeParam">T</span><span class="punctuation">&gt;</span> <span class="method">Build</span><span class="punctuation">&lt;</span><span class="typeParam">T</span><span class="punctuation">&gt;</span><span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">;</span></td></tr><tr><td class="line_no" line_no="177"></td><td class="code_column">    <span class="punctuation">}</span></td></tr><tr><td class="line_no" line_no="178"></td><td></tr><tr><td class="line_no" line_no="179"></td><td class="code_column">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="class">IdBuilder</span> <span class="punctuation">:</span> <span class="class">Builder</span></td></tr><tr><td class="line_no" line_no="180"></td><td class="code_column">    <span class="punctuation">{</span></td></tr><tr><td class="line_no" line_no="181"></td><td class="code_column">        <span class="keyword">public</span> <span class="keyword">override</span> <span class="interface">Monad</span><span class="punctuation">&lt;</span><span class="typeParam">T</span><span class="punctuation">&gt;</span> <span class="method">Build</span><span class="punctuation">&lt;</span><span class="typeParam">T</span><span class="punctuation">&gt;</span><span class="punctuation">(</span><span class="punctuation">)</span></td></tr><tr><td class="line_no" line_no="182"></td><td class="code_column">        <span class="punctuation">{</span></td></tr><tr><td class="line_no" line_no="183"></td><td class="code_column">            <span class="control">return</span> <span class="keyword">new</span> <span class="class">Id</span><span class="punctuation">&lt;</span><span class="typeParam">T</span><span class="punctuation">&gt;</span><span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">;</span></td></tr><tr><td class="line_no" line_no="184"></td><td class="code_column">        <span class="punctuation">}</span></td></tr><tr><td class="line_no" line_no="185"></td><td class="code_column">    <span class="punctuation">}</span></td></tr><tr><td class="line_no" line_no="186"></td><td></tr><tr><td class="line_no" line_no="187"></td><td class="code_column">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="class">AsyncBuilder</span> <span class="punctuation">:</span> <span class="class">Builder</span></td></tr><tr><td class="line_no" line_no="188"></td><td class="code_column">    <span class="punctuation">{</span></td></tr><tr><td class="line_no" line_no="189"></td><td class="code_column">        <span class="keyword">public</span> <span class="keyword">override</span> <span class="interface">Monad</span><span class="punctuation">&lt;</span><span class="typeParam">T</span><span class="punctuation">&gt;</span> <span class="method">Build</span><span class="punctuation">&lt;</span><span class="typeParam">T</span><span class="punctuation">&gt;</span><span class="punctuation">(</span><span class="punctuation">)</span></td></tr><tr><td class="line_no" line_no="190"></td><td class="code_column">        <span class="punctuation">{</span></td></tr><tr><td class="line_no" line_no="191"></td><td class="code_column">            <span class="control">return</span> <span class="keyword">new</span> <span class="class">Async</span><span class="punctuation">&lt;</span><span class="typeParam">T</span><span class="punctuation">&gt;</span><span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">;</span></td></tr><tr><td class="line_no" line_no="192"></td><td class="code_column">        <span class="punctuation">}</span></td></tr><tr><td class="line_no" line_no="193"></td><td class="code_column">    <span class="punctuation">}</span></td></tr><tr><td class="line_no" line_no="194"></td><td></tr><tr><td class="line_no" line_no="195"></td><td class="code_column">    <span class="keyword">public</span> <span class="keyword">interface</span> <span class="interface">Monad</span><span class="punctuation">&lt;</span><span class="typeParam">T</span><span class="punctuation">&gt;</span></td></tr><tr><td class="line_no" line_no="196"></td><td class="code_column">    <span class="punctuation">{</span></td></tr><tr><td class="line_no" line_no="197"></td><td class="code_column">        <span class="typeParam">U</span> <span class="method">Map</span><span class="punctuation">&lt;</span><span class="typeParam">U</span><span class="punctuation">&gt;</span><span class="punctuation">(</span><span class="typeParam">T</span> <span class="parameter">value</span><span class="punctuation">,</span> <span class="delegate">Func</span><span class="punctuation">&lt;</span><span class="typeParam">T</span><span class="punctuation">,</span> <span class="typeParam">U</span><span class="punctuation">&gt;</span> <span class="parameter">lambda</span><span class="punctuation">)</span><span class="punctuation">;</span></td></tr><tr><td class="line_no" line_no="198"></td><td class="code_column">        <span class="keyword">void</span> <span class="method">Complete</span><span class="punctuation">(</span><span class="typeParam">T</span> <span class="parameter">t</span><span class="punctuation">)</span><span class="punctuation">;</span></td></tr><tr><td class="line_no" line_no="199"></td><td class="code_column">    <span class="punctuation">}</span></td></tr><tr><td class="line_no" line_no="200"></td><td></tr><tr><td class="line_no" line_no="201"></td><td class="code_column">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="class">Id</span><span class="punctuation">&lt;</span><span class="typeParam">T</span><span class="punctuation">&gt;</span> <span class="punctuation">:</span> <span class="interface">Monad</span><span class="punctuation">&lt;</span><span class="typeParam">T</span><span class="punctuation">&gt;</span></td></tr><tr><td class="line_no" line_no="202"></td><td class="code_column">    <span class="punctuation">{</span></td></tr><tr><td class="line_no" line_no="203"></td><td class="code_column">        <span class="keyword">private</span> <span class="typeParam">T</span> <span class="fieldName">t</span><span class="punctuation">;</span></td></tr><tr><td class="line_no" line_no="204"></td><td></tr><tr><td class="line_no" line_no="205"></td><td class="code_column">        <span class="keyword">public</span> <span class="typeParam">U</span> <span class="method">Map</span><span class="punctuation">&lt;</span><span class="typeParam">U</span><span class="punctuation">&gt;</span><span class="punctuation">(</span><span class="typeParam">T</span> <span class="parameter">value</span><span class="punctuation">,</span> <span class="delegate">Func</span><span class="punctuation">&lt;</span><span class="typeParam">T</span><span class="punctuation">,</span> <span class="typeParam">U</span><span class="punctuation">&gt;</span> <span class="parameter">lambda</span><span class="punctuation">)</span></td></tr><tr><td class="line_no" line_no="206"></td><td class="code_column">        <span class="punctuation">{</span></td></tr><tr><td class="line_no" line_no="207"></td><td class="code_column">            <span class="keyword">this</span><span class="operator">.</span><span class="fieldName">t</span> <span class="operator">=</span> <span class="parameter">value</span><span class="punctuation">;</span></td></tr><tr><td class="line_no" line_no="208"></td><td class="code_column">            <span class="keyword">lock</span> <span class="punctuation">(</span><span class="keyword">this</span><span class="punctuation">)</span></td></tr><tr><td class="line_no" line_no="209"></td><td class="code_column">            <span class="punctuation">{</span></td></tr><tr><td class="line_no" line_no="210"></td><td class="code_column">                <span class="control">while</span> <span class="punctuation">(</span><span class="fieldName">t</span> <span class="operator">==</span> <span class="keyword">null</span><span class="punctuation">)</span></td></tr><tr><td class="line_no" line_no="211"></td><td class="code_column">                <span class="punctuation">{</span></td></tr><tr><td class="line_no" line_no="212"></td><td class="code_column">                    <span class="class">Monitor</span><span class="operator">.</span><span class="method">Wait</span><span class="punctuation">(</span><span class="keyword">this</span><span class="punctuation">)</span><span class="punctuation">;</span></td></tr><tr><td class="line_no" line_no="213"></td><td class="code_column">                <span class="punctuation">}</span></td></tr><tr><td class="line_no" line_no="214"></td><td class="code_column">            <span class="punctuation">}</span></td></tr><tr><td class="line_no" line_no="215"></td><td></tr><tr><td class="line_no" line_no="216"></td><td class="code_column">            <span class="control">return</span> <span class="parameter">lambda</span><span class="punctuation">(</span><span class="keyword">this</span><span class="operator">.</span><span class="fieldName">t</span><span class="punctuation">)</span><span class="punctuation">;</span></td></tr><tr><td class="line_no" line_no="217"></td><td class="code_column">        <span class="punctuation">}</span></td></tr><tr><td class="line_no" line_no="218"></td><td></tr><tr><td class="line_no" line_no="219"></td><td class="code_column">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="method">Complete</span><span class="punctuation">(</span><span class="typeParam">T</span> <span class="parameter">t</span><span class="punctuation">)</span></td></tr><tr><td class="line_no" line_no="220"></td><td class="code_column">        <span class="punctuation">{</span></td></tr><tr><td class="line_no" line_no="221"></td><td class="code_column">            <span class="keyword">lock</span> <span class="punctuation">(</span><span class="keyword">this</span><span class="punctuation">)</span></td></tr><tr><td class="line_no" line_no="222"></td><td class="code_column">            <span class="punctuation">{</span></td></tr><tr><td class="line_no" line_no="223"></td><td class="code_column">                <span class="keyword">this</span><span class="operator">.</span><span class="fieldName">t</span> <span class="operator">=</span> <span class="parameter">t</span><span class="punctuation">;</span></td></tr><tr><td class="line_no" line_no="224"></td><td class="code_column">                <span class="class">Monitor</span><span class="operator">.</span><span class="method">PulseAll</span><span class="punctuation">(</span><span class="keyword">this</span><span class="punctuation">)</span><span class="punctuation">;</span></td></tr><tr><td class="line_no" line_no="225"></td><td class="code_column">            <span class="punctuation">}</span></td></tr><tr><td class="line_no" line_no="226"></td><td class="code_column">        <span class="punctuation">}</span></td></tr><tr><td class="line_no" line_no="227"></td><td class="code_column">    <span class="punctuation">}</span></td></tr><tr><td class="line_no" line_no="228"></td><td></tr><tr><td class="line_no" line_no="229"></td><td class="code_column">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="class">Async</span><span class="punctuation">&lt;</span><span class="typeParam">T</span><span class="punctuation">&gt;</span> <span class="punctuation">:</span> <span class="interface">Monad</span><span class="punctuation">&lt;</span><span class="typeParam">T</span><span class="punctuation">&gt;</span></td></tr><tr><td class="line_no" line_no="230"></td><td class="code_column">    <span class="punctuation">{</span></td></tr><tr><td class="line_no" line_no="231"></td><td class="code_column">        <span class="keyword">private</span> <span class="typeParam">T</span> <span class="fieldName">t</span><span class="punctuation">;</span></td></tr><tr><td class="line_no" line_no="232"></td><td class="code_column">        <span class="keyword">private</span> <span class="keyword">int</span> <span class="fieldName">current</span><span class="punctuation">;</span></td></tr><tr><td class="line_no" line_no="233"></td><td></tr><tr><td class="line_no" line_no="234"></td><td class="code_column">        <span class="keyword">public</span> <span class="typeParam">U</span> <span class="method">Map</span><span class="punctuation">&lt;</span><span class="typeParam">U</span><span class="punctuation">&gt;</span><span class="punctuation">(</span><span class="typeParam">T</span> <span class="parameter">value</span><span class="punctuation">,</span> <span class="delegate">Func</span><span class="punctuation">&lt;</span><span class="typeParam">T</span><span class="punctuation">,</span> <span class="typeParam">U</span><span class="punctuation">&gt;</span> <span class="parameter">lambda</span><span class="punctuation">)</span></td></tr><tr><td class="line_no" line_no="235"></td><td class="code_column">        <span class="punctuation">{</span></td></tr><tr><td class="line_no" line_no="236"></td><td class="code_column">            <span class="keyword">this</span><span class="operator">.</span><span class="fieldName">t</span> <span class="operator">=</span> <span class="parameter">value</span><span class="punctuation">;</span></td></tr><tr><td class="line_no" line_no="237"></td><td class="code_column">            <span class="control">if</span> <span class="punctuation">(</span><span class="fieldName">t</span> <span class="operator">==</span> <span class="keyword">null</span><span class="punctuation">)</span></td></tr><tr><td class="line_no" line_no="238"></td><td class="code_column">            <span class="punctuation">{</span></td></tr><tr><td class="line_no" line_no="239"></td><td class="code_column">                <span class="keyword">this</span><span class="operator">.</span><span class="fieldName">current</span> <span class="operator">=</span> <span class="class">HKTMonadFiberAsync</span><span class="operator">.</span><span class="fieldName">current</span><span class="punctuation">;</span></td></tr><tr><td class="line_no" line_no="240"></td><td class="code_column">                <span class="keyword">byte</span> <span class="localName">b</span><span class="punctuation">;</span></td></tr><tr><td class="line_no" line_no="241"></td><td class="code_column">                <span class="class">HKTMonadFiberAsync</span><span class="operator">.</span><span class="fieldName">readyToGo</span><span class="operator">.</span><span class="method">TryRemove</span><span class="punctuation">(</span><span class="keyword">this</span><span class="operator">.</span><span class="fieldName">current</span><span class="punctuation">,</span> <span class="keyword">out</span> <span class="localName">b</span><span class="punctuation">)</span><span class="punctuation">;</span></td></tr><tr><td class="line_no" line_no="242"></td><td class="code_column">                <span class="class">HKTMonadFiberAsync</span><span class="operator">.</span><span class="fieldName">helper</span><span class="operator">.</span><span class="method">Switch</span><span class="punctuation">(</span><span class="numericLiteral">0</span><span class="punctuation">)</span><span class="punctuation">;</span></td></tr><tr><td class="line_no" line_no="243"></td><td class="code_column">            <span class="punctuation">}</span></td></tr><tr><td class="line_no" line_no="244"></td><td></tr><tr><td class="line_no" line_no="245"></td><td class="code_column">            <span class="control">return</span> <span class="parameter">lambda</span><span class="punctuation">(</span><span class="keyword">this</span><span class="operator">.</span><span class="fieldName">t</span><span class="punctuation">)</span><span class="punctuation">;</span></td></tr><tr><td class="line_no" line_no="246"></td><td class="code_column">        <span class="punctuation">}</span></td></tr><tr><td class="line_no" line_no="247"></td><td></tr><tr><td class="line_no" line_no="248"></td><td class="code_column">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="method">Complete</span><span class="punctuation">(</span><span class="typeParam">T</span> <span class="parameter">t</span><span class="punctuation">)</span></td></tr><tr><td class="line_no" line_no="249"></td><td class="code_column">        <span class="punctuation">{</span></td></tr><tr><td class="line_no" line_no="250"></td><td class="code_column">            <span class="keyword">this</span><span class="operator">.</span><span class="fieldName">t</span> <span class="operator">=</span> <span class="parameter">t</span><span class="punctuation">;</span></td></tr><tr><td class="line_no" line_no="251"></td><td class="code_column">            <span class="class">HKTMonadFiberAsync</span><span class="operator">.</span><span class="fieldName">readyToGo</span><span class="operator">.</span><span class="method">TryAdd</span><span class="punctuation">(</span><span class="keyword">this</span><span class="operator">.</span><span class="fieldName">current</span><span class="punctuation">,</span> <span class="numericLiteral">0</span><span class="punctuation">)</span><span class="punctuation">;</span></td></tr><tr><td class="line_no" line_no="252"></td><td class="code_column">        <span class="punctuation">}</span></td></tr><tr><td class="line_no" line_no="253"></td><td class="code_column">    <span class="punctuation">}</span></td></tr><tr><td class="line_no" line_no="254"></td><td class="code_column"><span class="punctuation">}</span></td></tr></tbody>
</table></pre>
