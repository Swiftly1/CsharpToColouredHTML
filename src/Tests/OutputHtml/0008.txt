
<pre class="background">
<span class="comment">// Licensed to the .NET Foundation under one or more agreements.</span>
<span class="comment">// The .NET Foundation licenses this file to you under the MIT license.</span>
<span class="comment">// See the LICENSE file in the project root for more information.</span>

<span class="preprocessor">#</span><span class="preprocessor">nullable</span> <span class="preprocessor">disable</span>

<span class="keyword">using</span> <span class="white">System</span><span class="white">;</span>
<span class="keyword">using</span> <span class="white">System</span><span class="white">.</span><span class="white">Collections</span><span class="white">.</span><span class="white">Generic</span><span class="white">;</span>
<span class="keyword">using</span> <span class="white">System</span><span class="white">.</span><span class="white">IO</span><span class="white">;</span>
<span class="keyword">using</span> <span class="white">System</span><span class="white">.</span><span class="white">Reflection</span><span class="white">;</span>
<span class="keyword">using</span> <span class="white">System</span><span class="white">.</span><span class="white">Runtime</span><span class="white">.</span><span class="white">InteropServices</span><span class="white">;</span>
<span class="keyword">using</span> <span class="white">System</span><span class="white">.</span><span class="white">Threading</span><span class="white">;</span>
<span class="keyword">using</span> <span class="white">System</span><span class="white">.</span><span class="white">Threading</span><span class="white">.</span><span class="white">Tasks</span><span class="white">;</span>
<span class="keyword">using</span> <span class="white">EnvDTE</span><span class="white">;</span>
<span class="keyword">using</span> <span class="white">Microsoft</span><span class="white">;</span>
<span class="keyword">using</span> <span class="white">Microsoft</span><span class="white">.</span><span class="white">VisualStudio</span><span class="white">.</span><span class="white">Shell</span><span class="white">;</span>
<span class="keyword">using</span> <span class="white">Microsoft</span><span class="white">.</span><span class="white">VisualStudio</span><span class="white">.</span><span class="white">Shell</span><span class="white">.</span><span class="white">Interop</span><span class="white">;</span>
<span class="keyword">using</span> <span class="class">Task</span> <span class="white">=</span> <span class="white">System</span><span class="white">.</span><span class="white">Threading</span><span class="white">.</span><span class="white">Tasks</span><span class="white">.</span><span class="class">Task</span><span class="white">;</span>

<span class="keyword">namespace</span> <span class="white">Roslyn</span><span class="white">.</span><span class="white">Compilers</span><span class="white">.</span><span class="white">Extension</span>
<span class="white">{</span>
    <span class="white">[</span><span class="class">Guid</span><span class="white">(</span><span class="string">&quot;31C0675E-87A4-4061-A0DD-A4E510FCCF97&quot;</span><span class="white">)</span><span class="white">]</span>
    <span class="keyword">public</span> <span class="keyword">sealed</span> <span class="keyword">class</span> <span class="class">CompilerPackage</span> <span class="white">:</span> <span class="class">AsyncPackage</span>
    <span class="white">{</span>
        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">string</span> <span class="white">RoslynHive</span> <span class="white">=</span> <span class="keyword">null</span><span class="white">;</span>

        <span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">async</span> <span class="class">Task</span> <span class="method">InitializeAsync</span><span class="white">(</span><span class="struct">CancellationToken</span> <span class="blue">cancellationToken</span><span class="white">,</span> <span class="interface">IProgress</span><span class="white">&lt;</span><span class="class">ServiceProgressData</span><span class="white">&gt;</span> <span class="blue">progress</span><span class="white">)</span>
        <span class="white">{</span>
            <span class="keyword">await</span> <span class="keyword">base</span><span class="white">.</span><span class="method">InitializeAsync</span><span class="white">(</span><span class="blue">cancellationToken</span><span class="white">,</span> <span class="blue">progress</span><span class="white">)</span><span class="white">.</span><span class="method">ConfigureAwait</span><span class="white">(</span><span class="keyword">true</span><span class="white">)</span><span class="white">;</span>

            <span class="keyword">await</span> <span class="class">JoinableTaskFactory</span><span class="white">.</span><span class="method">SwitchToMainThreadAsync</span><span class="white">(</span><span class="blue">cancellationToken</span><span class="white">)</span><span class="white">;</span>

            <span class="keyword">var</span> <span class="blue">reg</span> <span class="white">=</span> <span class="white">(</span><span class="white">ILocalRegistry2</span><span class="white">)</span><span class="keyword">await</span> <span class="method">GetServiceAsync</span><span class="white">(</span><span class="keyword">typeof</span><span class="white">(</span><span class="white">SLocalRegistry</span><span class="white">)</span><span class="white">)</span><span class="white">.</span><span class="method">ConfigureAwait</span><span class="white">(</span><span class="keyword">true</span><span class="white">)</span><span class="white">;</span>
            <span class="blue">cancellationToken</span><span class="white">.</span><span class="method">ThrowIfCancellationRequested</span><span class="white">(</span><span class="white">)</span><span class="white">;</span>
            <span class="class">Assumes</span><span class="white">.</span><span class="method">Present</span><span class="white">(</span><span class="blue">reg</span><span class="white">)</span><span class="white">;</span>

            <span class="keyword">var</span> <span class="blue">packagePath</span> <span class="white">=</span> <span class="class">Path</span><span class="white">.</span><span class="method">GetDirectoryName</span><span class="white">(</span><span class="class">Assembly</span><span class="white">.</span><span class="method">GetExecutingAssembly</span><span class="white">(</span><span class="white">)</span><span class="white">.</span><span class="white">Location</span><span class="white">)</span><span class="white">;</span>

            <span class="keyword">string</span> <span class="blue">localRegistryRoot</span><span class="white">;</span>
            <span class="blue">reg</span><span class="white">.</span><span class="method">GetLocalRegistryRoot</span><span class="white">(</span><span class="keyword">out</span> <span class="blue">localRegistryRoot</span><span class="white">)</span><span class="white">;</span>
            <span class="keyword">var</span> <span class="blue">registryParts</span> <span class="white">=</span> <span class="blue">localRegistryRoot</span><span class="white">.</span><span class="method">Split</span><span class="white">(</span><span class="string">&#39;\\&#39;</span><span class="white">)</span><span class="white">;</span>

            <span class="comment">// Is it a valid Hive looks similar to:  </span>
            <span class="comment">//  &#39;Software\Microsoft\VisualStudio\14.0&#39;  &#39;Software\Microsoft\VisualStudio\14.0Roslyn&#39;  &#39;Software\Microsoft\VSWinExpress\14.0&#39;</span>
            <span class="control">if</span> <span class="white">(</span><span class="blue">registryParts</span><span class="white">.</span><span class="white">Length</span> <span class="white">&gt;=</span> <span class="interface">4</span><span class="white">)</span>
            <span class="white">{</span>
                <span class="keyword">var</span> <span class="blue">skuName</span> <span class="white">=</span> <span class="blue">registryParts</span><span class="white">[</span><span class="interface">2</span><span class="white">]</span><span class="white">;</span>
                <span class="keyword">var</span> <span class="blue">hiveName</span> <span class="white">=</span> <span class="blue">registryParts</span><span class="white">[</span><span class="interface">3</span><span class="white">]</span><span class="white">;</span>
                <span class="white">RoslynHive</span> <span class="white">=</span> <span class="keyword">string</span><span class="white">.</span><span class="method">Format</span><span class="white">(</span><span class="string">@&quot;{0}.{1}&quot;</span><span class="white">,</span> <span class="blue">registryParts</span><span class="white">[</span><span class="interface">2</span><span class="white">]</span><span class="white">,</span> <span class="blue">registryParts</span><span class="white">[</span><span class="interface">3</span><span class="white">]</span><span class="white">)</span><span class="white">;</span>

                <span class="keyword">await</span> <span class="method">WriteMSBuildFilesAsync</span><span class="white">(</span><span class="blue">packagePath</span><span class="white">,</span> <span class="white">RoslynHive</span><span class="white">,</span> <span class="blue">cancellationToken</span><span class="white">)</span><span class="white">.</span><span class="method">ConfigureAwait</span><span class="white">(</span><span class="keyword">true</span><span class="white">)</span><span class="white">;</span>

                <span class="control">try</span>
                <span class="white">{</span>
                    <span class="white">Microsoft</span><span class="white">.</span><span class="white">Build</span><span class="white">.</span><span class="white">Evaluation</span><span class="white">.</span><span class="white">ProjectCollection</span><span class="white">.</span><span class="class">GlobalProjectCollection</span><span class="white">.</span><span class="white">DisableMarkDirty</span> <span class="white">=</span> <span class="keyword">true</span><span class="white">;</span>
                    <span class="white">Microsoft</span><span class="white">.</span><span class="white">Build</span><span class="white">.</span><span class="white">Evaluation</span><span class="white">.</span><span class="white">ProjectCollection</span><span class="white">.</span><span class="class">GlobalProjectCollection</span><span class="white">.</span><span class="method">SetGlobalProperty</span><span class="white">(</span><span class="string">&quot;RoslynHive&quot;</span><span class="white">,</span> <span class="white">RoslynHive</span><span class="white">)</span><span class="white">;</span>
                <span class="white">}</span>
                <span class="control">finally</span>
                <span class="white">{</span>
                    <span class="white">Microsoft</span><span class="white">.</span><span class="white">Build</span><span class="white">.</span><span class="white">Evaluation</span><span class="white">.</span><span class="white">ProjectCollection</span><span class="white">.</span><span class="class">GlobalProjectCollection</span><span class="white">.</span><span class="white">DisableMarkDirty</span> <span class="white">=</span> <span class="keyword">false</span><span class="white">;</span>
                <span class="white">}</span>
            <span class="white">}</span>
        <span class="white">}</span>

        <span class="keyword">private</span> <span class="keyword">async</span> <span class="class">Task</span> <span class="method">WriteMSBuildFilesAsync</span><span class="white">(</span><span class="keyword">string</span> <span class="blue">packagePath</span><span class="white">,</span> <span class="keyword">string</span> <span class="blue">hiveName</span><span class="white">,</span> <span class="struct">CancellationToken</span> <span class="blue">cancellationToken</span><span class="white">)</span>
        <span class="white">{</span><span class="comment">
            // A map of the file name to the content we need to ensure exists in the file</span>
            <span class="keyword">var</span> <span class="blue">filesToWrite</span> <span class="white">=</span> <span class="keyword">new</span> <span class="class">Dictionary</span><span class="white">&lt;</span><span class="keyword">string</span><span class="white">,</span> <span class="keyword">string</span><span class="white">&gt;</span><span class="white">(</span><span class="class">StringComparer</span><span class="white">.</span><span class="white">OrdinalIgnoreCase</span><span class="white">)</span><span class="white">;</span><span class="comment">

            // The props we want to be included as early as possible since we want our tasks to be used and</span><span class="comment">
            // to ensure our setting of targets path happens early enough</span>
            <span class="blue">filesToWrite</span><span class="white">.</span><span class="method">Add</span><span class="white">(</span><span class="keyword">await</span> <span class="method">GetMSBuildRelativePathAsync</span><span class="white">(</span><span class="string">$@&quot;</span><span class="string">Imports\Microsoft.Common.props\ImportBefore\Roslyn.Compilers.Extension.</span><span class="white">{</span><span class="blue">hiveName</span><span class="white">}</span><span class="string">.props</span><span class="string">&quot;</span><span class="white">,</span> <span class="blue">cancellationToken</span><span class="white">)</span><span class="white">.</span><span class="method">ConfigureAwait</span><span class="white">(</span><span class="keyword">true</span><span class="white">)</span><span class="white">,</span><span class="string">
                $@&quot;</span><span class="string">&lt;?xml version=&quot;&quot;1.0&quot;&quot; encoding=&quot;&quot;utf-8&quot;&quot;?&gt;</span>
<span class="string">&lt;Project xmlns=&quot;&quot;http://schemas.microsoft.com/developer/msbuild/2003&quot;&quot;&gt;</span><span class="string">
  &lt;PropertyGroup Condition=&quot;&quot;&#39;$(RoslynHive)&#39; == &#39;</span><span class="white">{</span><span class="blue">hiveName</span><span class="white">}</span><span class="string">&#39;&quot;&quot;&gt;</span><span class="string">
    &lt;CSharpCoreTargetsPath&gt;</span><span class="white">{</span><span class="blue">packagePath</span><span class="white">}</span><span class="string">\Microsoft.CSharp.Core.targets&lt;/CSharpCoreTargetsPath&gt;</span><span class="string">
    &lt;VisualBasicCoreTargetsPath&gt;</span><span class="white">{</span><span class="blue">packagePath</span><span class="white">}</span><span class="string">\Microsoft.VisualBasic.Core.targets&lt;/VisualBasicCoreTargetsPath&gt;</span><span class="string">
  &lt;/PropertyGroup&gt; </span><span class="string">
</span><span class="string">
  &lt;UsingTask TaskName=&quot;&quot;Microsoft.CodeAnalysis.BuildTasks.Csc&quot;&quot; AssemblyFile=&quot;&quot;</span><span class="white">{</span><span class="blue">packagePath</span><span class="white">}</span><span class="string">\Microsoft.Build.Tasks.CodeAnalysis.dll&quot;&quot; Condition=&quot;&quot;&#39;$(RoslynHive)&#39; == &#39;</span><span class="white">{</span><span class="blue">hiveName</span><span class="white">}</span><span class="string">&#39;&quot;&quot; /&gt;</span><span class="string">
  &lt;UsingTask TaskName=&quot;&quot;Microsoft.CodeAnalysis.BuildTasks.Vbc&quot;&quot; AssemblyFile=&quot;&quot;</span><span class="white">{</span><span class="blue">packagePath</span><span class="white">}</span><span class="string">\Microsoft.Build.Tasks.CodeAnalysis.dll&quot;&quot; Condition=&quot;&quot;&#39;$(RoslynHive)&#39; == &#39;</span><span class="white">{</span><span class="blue">hiveName</span><span class="white">}</span><span class="string">&#39;&quot;&quot; /&gt;</span>
<span class="string">&lt;/Project&gt;</span><span class="string">&quot;</span><span class="white">)</span><span class="white">;</span><span class="comment">

            // This targets content we want to be included later since the project file might touch UseSharedCompilation</span>
            <span class="keyword">var</span> <span class="blue">targetsContent</span> <span class="white">=</span><span class="string">
                    $@&quot;</span><span class="string">&lt;?xml version=&quot;&quot;1.0&quot;&quot; encoding=&quot;&quot;utf-8&quot;&quot;?&gt;</span>
<span class="string">&lt;Project xmlns=&quot;&quot;http://schemas.microsoft.com/developer/msbuild/2003&quot;&quot;&gt;</span><span class="string">
  &lt;!-- If we&#39;re not using the compiler server, set ToolPath/Exe to direct to the exes in this package --&gt;</span><span class="string">
  &lt;PropertyGroup Condition=&quot;&quot;&#39;$(RoslynHive)&#39; == &#39;</span><span class="white">{</span><span class="blue">hiveName</span><span class="white">}</span><span class="string">&#39; and &#39;$(UseSharedCompilation)&#39; == &#39;false&#39;&quot;&quot;&gt;</span><span class="string">
    &lt;CscToolPath&gt;</span><span class="white">{</span><span class="blue">packagePath</span><span class="white">}</span><span class="string">&lt;/CscToolPath&gt;</span><span class="string">
    &lt;CscToolExe&gt;csc.exe&lt;/CscToolExe&gt;</span><span class="string">
    &lt;VbcToolPath&gt;</span><span class="white">{</span><span class="blue">packagePath</span><span class="white">}</span><span class="string">&lt;/VbcToolPath&gt;</span><span class="string">
    &lt;VbcToolExe&gt;vbc.exe&lt;/VbcToolExe&gt;</span><span class="string">
  &lt;/PropertyGroup&gt;</span>
<span class="string">&lt;/Project&gt;</span><span class="string">&quot;</span><span class="white">;</span>

            <span class="blue">filesToWrite</span><span class="white">.</span><span class="method">Add</span><span class="white">(</span><span class="keyword">await</span> <span class="method">GetMSBuildRelativePathAsync</span><span class="white">(</span><span class="string">$@&quot;</span><span class="string">Microsoft.CSharp.targets\ImportBefore\Roslyn.Compilers.Extension.</span><span class="white">{</span><span class="blue">hiveName</span><span class="white">}</span><span class="string">.targets</span><span class="string">&quot;</span><span class="white">,</span> <span class="blue">cancellationToken</span><span class="white">)</span><span class="white">.</span><span class="method">ConfigureAwait</span><span class="white">(</span><span class="keyword">true</span><span class="white">)</span><span class="white">,</span> <span class="blue">targetsContent</span><span class="white">)</span><span class="white">;</span>
            <span class="blue">filesToWrite</span><span class="white">.</span><span class="method">Add</span><span class="white">(</span><span class="keyword">await</span> <span class="method">GetMSBuildRelativePathAsync</span><span class="white">(</span><span class="string">$@&quot;</span><span class="string">Microsoft.VisualBasic.targets\ImportBefore\Roslyn.Compilers.Extension.</span><span class="white">{</span><span class="blue">hiveName</span><span class="white">}</span><span class="string">.targets</span><span class="string">&quot;</span><span class="white">,</span> <span class="blue">cancellationToken</span><span class="white">)</span><span class="white">.</span><span class="method">ConfigureAwait</span><span class="white">(</span><span class="keyword">true</span><span class="white">)</span><span class="white">,</span> <span class="blue">targetsContent</span><span class="white">)</span><span class="white">;</span><span class="comment">

            // First we want to ensure any Roslyn files with our hive name that we aren&#39;t writing -- this is probably</span><span class="comment">
            // leftovers from older extensions</span>
            <span class="keyword">var</span> <span class="blue">msbuildDirectory</span> <span class="white">=</span> <span class="keyword">new</span> <span class="class">DirectoryInfo</span><span class="white">(</span><span class="keyword">await</span> <span class="method">GetMSBuildPathAsync</span><span class="white">(</span><span class="blue">cancellationToken</span><span class="white">)</span><span class="white">.</span><span class="method">ConfigureAwait</span><span class="white">(</span><span class="keyword">true</span><span class="white">)</span><span class="white">)</span><span class="white">;</span>
            <span class="control">if</span> <span class="white">(</span><span class="blue">msbuildDirectory</span><span class="white">.</span><span class="white">Exists</span><span class="white">)</span>
            <span class="white">{</span>
                <span class="control">foreach</span> <span class="white">(</span><span class="keyword">var</span> <span class="blue">file</span> <span class="control">in</span> <span class="blue">msbuildDirectory</span><span class="white">.</span><span class="method">EnumerateFiles</span><span class="white">(</span><span class="string">$&quot;</span><span class="string">*Roslyn*</span><span class="white">{</span><span class="blue">hiveName</span><span class="white">}</span><span class="string">*</span><span class="string">&quot;</span><span class="white">,</span> <span class="interface">SearchOption</span><span class="white">.</span><span class="white">AllDirectories</span><span class="white">)</span><span class="white">)</span>
                <span class="white">{</span>
                    <span class="control">if</span> <span class="white">(</span><span class="white">!</span><span class="blue">filesToWrite</span><span class="white">.</span><span class="method">ContainsKey</span><span class="white">(</span><span class="blue">file</span><span class="white">.</span><span class="white">FullName</span><span class="white">)</span><span class="white">)</span>
                    <span class="white">{</span>
                        <span class="blue">file</span><span class="white">.</span><span class="method">Delete</span><span class="white">(</span><span class="white">)</span><span class="white">;</span>
                    <span class="white">}</span>
                <span class="white">}</span>
            <span class="white">}</span>

            <span class="control">try</span>
            <span class="white">{</span>
                <span class="control">foreach</span> <span class="white">(</span><span class="keyword">var</span> <span class="blue">fileAndContents</span> <span class="control">in</span> <span class="blue">filesToWrite</span><span class="white">)</span>
                <span class="white">{</span>
                    <span class="keyword">var</span> <span class="blue">parentDirectory</span> <span class="white">=</span> <span class="keyword">new</span> <span class="class">DirectoryInfo</span><span class="white">(</span><span class="class">Path</span><span class="white">.</span><span class="method">GetDirectoryName</span><span class="white">(</span><span class="blue">fileAndContents</span><span class="white">.</span><span class="white">Key</span><span class="white">)</span><span class="white">)</span><span class="white">;</span>
                    <span class="blue">parentDirectory</span><span class="white">.</span><span class="method">Create</span><span class="white">(</span><span class="white">)</span><span class="white">;</span><span class="comment">

                    // If we already know the file has the same contents, then we can skip</span>
                    <span class="control">if</span> <span class="white">(</span><span class="class">File</span><span class="white">.</span><span class="method">Exists</span><span class="white">(</span><span class="blue">fileAndContents</span><span class="white">.</span><span class="white">Key</span><span class="white">)</span> <span class="white">&amp;&amp;</span> <span class="class">File</span><span class="white">.</span><span class="method">ReadAllText</span><span class="white">(</span><span class="blue">fileAndContents</span><span class="white">.</span><span class="white">Key</span><span class="white">)</span> <span class="white">==</span> <span class="blue">fileAndContents</span><span class="white">.</span><span class="white">Value</span><span class="white">)</span>
                    <span class="white">{</span>
                        <span class="control">continue</span><span class="white">;</span>
                    <span class="white">}</span>

                    <span class="class">File</span><span class="white">.</span><span class="method">WriteAllText</span><span class="white">(</span><span class="blue">fileAndContents</span><span class="white">.</span><span class="white">Key</span><span class="white">,</span> <span class="blue">fileAndContents</span><span class="white">.</span><span class="white">Value</span><span class="white">)</span><span class="white">;</span>
                <span class="white">}</span>
            <span class="white">}</span>
            <span class="control">catch</span> <span class="white">(</span><span class="class">Exception</span> <span class="blue">e</span><span class="white">)</span>
            <span class="white">{</span>
                <span class="keyword">var</span> <span class="blue">msg</span> <span class="white">=</span><span class="string">
$@&quot;</span><span class="white">{</span><span class="blue">e</span><span class="white">.</span><span class="white">Message</span><span class="white">}</span><span class="string"></span><span class="string">
</span>
<span class="string">To reload the Roslyn compiler package, close Visual Studio and any MSBuild processes, then restart Visual Studio.</span><span class="string">&quot;</span><span class="white">;</span>

                <span class="class">VsShellUtilities</span><span class="white">.</span><span class="method">ShowMessageBox</span><span class="white">(</span>
                    <span class="keyword">this</span><span class="white">,</span>
                    <span class="blue">msg</span><span class="white">,</span>
                    <span class="keyword">null</span><span class="white">,</span>
                    <span class="class">OLEMSGICON</span><span class="white">.</span><span class="white">OLEMSGICON_WARNING</span><span class="white">,</span>
                    <span class="class">OLEMSGBUTTON</span><span class="white">.</span><span class="white">OLEMSGBUTTON_OK</span><span class="white">,</span>
                    <span class="class">OLEMSGDEFBUTTON</span><span class="white">.</span><span class="white">OLEMSGDEFBUTTON_FIRST</span><span class="white">)</span><span class="white">;</span>
            <span class="white">}</span>
        <span class="white">}</span>


        <span class="keyword">private</span> <span class="keyword">async</span> <span class="class">Task</span><span class="white">&lt;</span><span class="keyword">string</span><span class="white">&gt;</span> <span class="method">GetMSBuildVersionStringAsync</span><span class="white">(</span><span class="struct">CancellationToken</span> <span class="blue">cancellationToken</span><span class="white">)</span>
        <span class="white">{</span>
            <span class="keyword">await</span> <span class="white">ThreadHelper</span><span class="white">.</span><span class="class">JoinableTaskFactory</span><span class="white">.</span><span class="method">SwitchToMainThreadAsync</span><span class="white">(</span><span class="blue">cancellationToken</span><span class="white">)</span><span class="white">;</span>

            <span class="keyword">var</span> <span class="blue">dte</span> <span class="white">=</span> <span class="white">(</span><span class="white">DTE</span><span class="white">)</span><span class="keyword">await</span> <span class="method">GetServiceAsync</span><span class="white">(</span><span class="keyword">typeof</span><span class="white">(</span><span class="white">SDTE</span><span class="white">)</span><span class="white">)</span><span class="white">.</span><span class="method">ConfigureAwait</span><span class="white">(</span><span class="keyword">true</span><span class="white">)</span><span class="white">;</span>
            <span class="keyword">var</span> <span class="blue">parts</span> <span class="white">=</span> <span class="blue">dte</span><span class="white">.</span><span class="white">Version</span><span class="white">.</span><span class="method">Split</span><span class="white">(</span><span class="string">&#39;.&#39;</span><span class="white">)</span><span class="white">;</span>
            <span class="control">if</span> <span class="white">(</span><span class="blue">parts</span><span class="white">.</span><span class="white">Length</span><span class="white"> !=</span> <span class="interface">2</span><span class="white">)</span>
            <span class="white">{</span>
                <span class="control">throw</span> <span class="keyword">new</span> <span class="class">Exception</span><span class="white">(</span><span class="string">$&quot;</span><span class="string">Unrecognized Visual Studio Version: </span><span class="white">{</span><span class="blue">dte</span><span class="white">.</span><span class="white">Version</span><span class="white">}</span><span class="string">&quot;</span><span class="white">)</span><span class="white">;</span>
            <span class="white">}</span>

            <span class="keyword">int</span> <span class="blue">majorVersion</span> <span class="white">=</span> <span class="keyword">int</span><span class="white">.</span><span class="method">Parse</span><span class="white">(</span><span class="blue">parts</span><span class="white">[</span><span class="interface">0</span><span class="white">]</span><span class="white">)</span><span class="white">;</span>

            <span class="control">if</span> <span class="white">(</span><span class="blue">majorVersion</span> <span class="white">&gt;=</span> <span class="interface">16</span><span class="white">)</span>
            <span class="white">{</span><span class="comment">
                // Starting in Visual Studio 2019, the folder is just called &quot;Current&quot;. See</span><span class="comment">
                // https://github.com/Microsoft/msbuild/issues/4149 for further commentary.</span>
                <span class="control">return</span> <span class="string">&quot;Current&quot;</span><span class="white">;</span>
            <span class="white">}</span>
            <span class="control">else</span>
            <span class="white">{</span>
                <span class="control">return</span> <span class="blue">majorVersion</span><span class="white"> +</span> <span class="string">&quot;.0&quot;</span><span class="white">;</span>
            <span class="white">}</span>
        <span class="white">}</span>

        <span class="keyword">private</span> <span class="keyword">async</span> <span class="class">Task</span><span class="white">&lt;</span><span class="keyword">string</span><span class="white">&gt;</span> <span class="method">GetMSBuildPathAsync</span><span class="white">(</span><span class="struct">CancellationToken</span> <span class="blue">cancellationToken</span><span class="white">)</span>
        <span class="white">{</span>
            <span class="keyword">var</span> <span class="blue">version</span> <span class="white">=</span> <span class="keyword">await</span> <span class="method">GetMSBuildVersionStringAsync</span><span class="white">(</span><span class="blue">cancellationToken</span><span class="white">)</span><span class="white">.</span><span class="method">ConfigureAwait</span><span class="white">(</span><span class="keyword">true</span><span class="white">)</span><span class="white">;</span>
            <span class="keyword">var</span> <span class="blue">localAppData</span> <span class="white">=</span> <span class="class">Environment</span><span class="white">.</span><span class="method">GetFolderPath</span><span class="white">(</span><span class="class">Environment</span><span class="white">.</span><span class="interface">SpecialFolder</span><span class="white">.</span><span class="white">LocalApplicationData</span><span class="white">)</span><span class="white">;</span>
            <span class="control">return</span> <span class="class">Path</span><span class="white">.</span><span class="method">Combine</span><span class="white">(</span><span class="blue">localAppData</span><span class="white">,</span><span class="string"> $@&quot;</span><span class="string">Microsoft\MSBuild\</span><span class="white">{</span><span class="blue">version</span><span class="white">}</span><span class="string">&quot;</span><span class="white">)</span><span class="white">;</span>
        <span class="white">}</span>

        <span class="keyword">private</span> <span class="keyword">async</span> <span class="class">Task</span><span class="white">&lt;</span><span class="keyword">string</span><span class="white">&gt;</span> <span class="method">GetMSBuildRelativePathAsync</span><span class="white">(</span><span class="keyword">string</span> <span class="blue">relativePath</span><span class="white">,</span> <span class="struct">CancellationToken</span> <span class="blue">cancellationToken</span><span class="white">)</span>
        <span class="white">{</span>
            <span class="control">return</span> <span class="class">Path</span><span class="white">.</span><span class="method">Combine</span><span class="white">(</span><span class="keyword">await</span> <span class="method">GetMSBuildPathAsync</span><span class="white">(</span><span class="blue">cancellationToken</span><span class="white">)</span><span class="white">.</span><span class="method">ConfigureAwait</span><span class="white">(</span><span class="keyword">true</span><span class="white">)</span><span class="white">,</span> <span class="blue">relativePath</span><span class="white">)</span><span class="white">;</span>
        <span class="white">}</span>
    <span class="white">}</span>
<span class="white">}</span></pre>
